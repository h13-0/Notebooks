#计算机网络 #应试笔记与八股

## 目录
```toc
```

## 5.1 传输层提供的服务

### 5.1.1 传输层的功能

在OSI七层模型中，传输层位于表示层和传输层之间。对于通信来说，传输层是最高层；对于用户来说，传输层是最底层。非主机的网络设备(如路由器、网关)通常不涉及传输层的协议和功能，通常只有主机才涉及传输层的相关协议和功能。其主要功能如下：
1. 为进程与进程之间提供逻辑通信。
2. 复用和分用：
	1. 复用：应用层的所有应用进程都可以通过传输层传输到应用层
	2. 分用：传输层从网络层接收到的数据会交付给对应的应用进程(通过端口绑定应用)
3. 对网络层进行报文差错检测，可以可选地提供可靠传输。

其主要协议有：
1. <font color="#9bbb59">TCP</font>协议(Transmission Control Protocol)：
	- 是<font color="#c00000">面向连接</font>的<font color="#9bbb59">传输控制协议</font>
	- 传输数据需要建立连接
	- 接收方在收到数据后需要确认
	- 不提供广播或多播服务
	- 可靠，时延高
2. <font color="#9bbb59">UDP</font>协议(User Datagram Protocol)：
	- 是无连接的<font color="#9bbb59">用户数据报协议</font>
	- 传输数据报前不需要建立连接
	- 接收端收到数据报后也不需要任何确认
	- 提供广播或多播服务
	- 不可靠，时延低

### 5.1.2 传输层的寻址与端口

端口号的划分(属于约定，不具有强制力)：
	端口号主要按范围进行划分，大致如下：
	1. 服务端使用的端口号：范围\[0, 49151\]，具体划分如下：
		1. 熟知端口号：\[0, 1023\]，主要分配给重要重要的应用程序，常见程序分配表如下：
			![[Pasted image 20240317161802.png]]
		2. 登记端口号：\[1024, 49151\]
	2. 客户端使用的端口号：范围\[0, 65535\]，在客户端程序运行时动态随机分配

在程序设计时，<font color="#c00000">通常用套接字绑定IP地址和端口号</font>(套接字，socket，意译为插槽)。

## 5.2 UDP协议

### 5.2.1 UDP数据报

UDP只是在IP数据报服务上提供了传输层的基本功能(即为进程提供socket逻辑通信，提供复用和分用)，其特点为：
1. UDP无连接，减少开销和时延
2. UDP和网络层一样尽最大努力交付，不保证可靠交付，即<font color="#c00000">不可靠传输</font>
3. UDP是面向报文的，<font color="#c00000">只添加了一个很小的分组首部</font>(<span style="background:#fff88f"><font color="#c00000">8 Byte</font></span>)，<span style="background:#fff88f"><font color="#c00000">对应用层报文既不合并又不拆分</font></span>，<font color="#c00000">一次发送一个完整报文</font>，需要应用自行分片，<font color="#c00000">也适合一次传输少量数据</font>：
	![[Pasted image 20240317163923.png]]
4. UDP无拥塞控制，适合实时性应用(即使网络拥塞，发送方依旧恒定速率发送)

UDP的首部格式：
	UDP首部只有8 Byte，只存了源端口、目的端口、UDP长度(<span style="background:#fff88f"><font color="#c00000">为整个UDP报文长度</font></span>)。源IP和目的IP在IP数据报中。<span style="background:#fff88f"><font color="#c00000">UDP包可以不要数据段，长度最少为8</font></span>。
	![[Pasted image 20240317165313.png]]
		当找不到目的端口时，则UDP数据报会被丢弃，<font color="#c00000">并发送ICMP端口不可达差错报文</font>。
		当UDP检验和校验错误，则UDP数据报会被丢弃。

### 5.2.2 UDP校验和

UDP在生成校验和时，<font color="#c00000">会生成一个伪首部</font>，<font color="#c00000">该伪首部相似于IP数据报报头</font><span style="background:#fff88f"><font color="#c00000">但不同于IP数据报</font></span>，<font color="#c00000">该伪首部只参与校验和计算</font>，<span style="background:#fff88f"><font color="#c00000">不参与传输</font></span>：
	![[Pasted image 20240317170318.png]]
	校验和适用二进制反码求和再反码(<font color="#c00000">会检验数据部分</font>)，具体计算规则如下：
	1. 各二进制位正常求和，正常溢出
	2. 若最高位产生溢出，则再原基础上再加 `1` 
	![[Pasted image 20240317170544.png]]
	在发送时，上图UDP首部中<font color="#c00000">校验和位设置为0</font>后再计算，计算结果填充回原校验和位。
	在接收时，<font color="#c00000">直接进行计算</font>，<font color="#c00000">若最后计算结果全1</font>，<font color="#c00000">则校验成功</font>。

## 5.3 TCP协议

### 5.3.1 TCP协议的特点

TCP的特点主要有：
1. 是面向连接(虚链接)的传输层协议
2. 每一条TCP连接只能有两个端点，即<span style="background:#fff88f"><font color="#c00000">点对点连接</font></span>。
3. TCP提供可靠交付服务，可以使报文段<font color="#c00000">无差错</font>、<font color="#c00000">不丢失</font>、<font color="#c00000">不重复</font>、<font color="#c00000">按顺序</font>到达。
4. TCP可以提供全双工通信，有发送缓存和接收缓存：
	1. 发送缓存：
		- 缓存准备发送的数据
		- 缓存已发送但未收到确认的数据
	2. 接收缓存：
		- 缓存按序到达但尚未被应用程序接收的数据
		- 缓存未按序到达的数据
5. TCP面向字节流，TCP在传输交付来的数据时会将数据看成一个无结构的二进制字节流。
6. 采用C/S模式。

### 5.3.2 TCP报文段

TCP报文段的结构如下：
	![[Pasted image 20240317174203.png]]
各字段结构如下：
1. 源端口
2. 目的端口
3. 序号：TCP数据部分的第一个字节在该TCP连接所发送的所有字节中的序号。<span style="background:#fff88f"><font color="#c00000">建立连接或释放连接使用的特殊报文段(SYN/FIN)</font></span>或不携带数据的TCP报文段<span style="background:#fff88f"><font color="#c00000">也要消耗一个序号</font></span>。
4. 确认号：为接收方在收到该数据报之后的应答号，<span style="background:#fff88f"><font color="#c00000">当接受方应答该号则表示该号之前的所有报文均接收完毕</font></span>，<font color="#c00000">可以传输该确认号对应的报文段</font>，通常为序号+数据段长度。
5. 数据偏移字段：<font color="#c00000">又叫报文头部长度字段</font>，该TCP数据段的起始处距离该报文的起始段有多少偏移量(<font color="#c00000">因为TCP首部长度可变</font>，有选项字段)，<span style="background:#fff88f"><font color="#c00000">相当于TCP首部长度</font></span>，以4 Byte为单位。
6. 控制位：
	1. `URG` ：urgent，表示该报文要紧急传输，不用在<font color="#c00000">发送缓存</font>中排队，<font color="#c00000">要配合紧急指针使用</font>。
	2. `ACK` ：确认位，只有 `ACK=1` 时<font color="#c00000">确认号才有效</font>，才开启TCP确认机制。
	3. `PSH` ：push，要求接收方尽快接收该数据，不用在<font color="#c00000">接收缓存</font>中排队。
	4. `RST` ：复位，表示TCP中出现了严重差错，必须重新建立连接，也可以用于拒绝一个非法报文段，或拒绝打开连接。
	5. `SYN` ：同步位，表示是请求建立连接的报文。
	6. `FIN` ：finish，表示报文传输完毕，要求释放连接。
7. 窗口字段：16位，范围\[0, 65535\]表示发送方或接收方的发送/接收窗口有多大，以便于双方同步缓存大小。该值允许发送方和接收方之间动态调节。<span style="background:#fff88f"><font color="#c00000">当TCP数据报中数据不足窗口大小，并调用</font></span> `flush` <span style="background:#fff88f"><font color="#c00000">时，会强制发送</font></span>。<font color="#c00000">TCP并没有提供数据段长度的标志位，其需要通过IP数据段长度减去偏移量获得</font>。
8. 校验和：检验首部部分和数据部分，也有伪首部，规则同UDP，只有协议字段不同。
9. 紧急指针：<font color="#c00000">本紧急报文的数据字段的起始位置</font>，只有 `URG=1` 时有意义。但是序号字段也可以确定偏移量...
[TODO 似乎有点问题，建议找TCP规范核实]
问题：
1. 紧急数据报可以携带普通数据吗
	1. 如果可以携带，那紧急数据的偏移量可以和普通数据的偏移量不连续吗，比如我紧急数据的偏移量是4096，普通数据的偏移量是1024。
		1. 如果可以不连续，那现在可以用来标记的字段有且仅有 `序号` 、 `数据偏移` 、 `紧急指针` ，那如何同时标记 `报文中紧急数据起始地址` 、 `报文中普通数据起始地址` 、 `紧急数据偏移量4096` 、 `普通数据偏移量1024`
		2. 如果不可以不连续，那携带普通数据的意义是？为什么 `数据偏移` 只用4位就可以确定 `报文中普通数据起始地址` ，而 `紧急指针` 却要用16位来确定 `报文中紧急数据起始地址` ？
	2. 如果不可以携带，那 `序号` 就可以标记紧急数据的偏移量，紧急指针是干什么的?

### 5.3.3 TCP连接管理

TCP连接有如下三个阶段：
1. 建立连接
2. 数据传送
3. 连接释放
其中，连接只能由客户端发起，服务端要提前开始监听。

<span style="background:#fff88f"><font color="#c00000"><B>TCP连接的建立</B></font></span>




