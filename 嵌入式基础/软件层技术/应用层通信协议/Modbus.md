---
number headings: auto, first-level 2, max 6, 1.1
---
#嵌入式 

## 1 目录

```toc
```

## 2 Modbus概述

Modbus有如下三种协议：
- Modbus ASCII
- Modbus RTU
- Modbus TCP
Modbus协议规定，使用Modbus的设备必须支持Modbus RTU，且默认为Modbus RTU，因此大多数设备使用的均为Modbus RTU。

### 2.1 Modbus RTU

Modbus RTU可以分为主站和从站，请求报文可以分为如下几个部分：

| 地址域   | 功能码   | 数据   | 差错校验 |
| ----- | ----- | ---- | ---- |
| 1Byte | 1Byte | 长度不定 |      |
其中：
- 地址域共计1Byte，被划分为：
	- 地址 $0$ 被划分为广播地址
	- 地址 $[1, 247]$ 被划分为子节点单独地址
	- 地址 $[248, 255]$ 被用作保留地址
	因此：
	- 从机地址范围被定义在 $[1, 247]$ 
	- 保留区可以用于设置特定地址段的广播指令等
- `${功能码}${数据}` 部分被称作PDU(协议数据单元)，其中功能码固定为1Byte，数据长度不定。详见[[Modbus#2 1 1 PDU协议数据单元|PDU协议数据单元]]。




根据地址不同，Modbus可以分为广播和单播两种模式：
- 在广播模式下，所有从站必须执行主站命令而无需应答返回。
- 在单播模式下，子节点必须做出应答，只有应答完成后主节点才可以做出下一个事务处理。
同一时刻，主节点只能发起一个Modbus事务处理。
<font color="#c00000">不管任何模式，子节点都不会主动发送数据</font>。


#### 2.1.1 PDU协议数据单元

PDU协议数据单元可以分为长度为1Byte的功能码，以及长度不定的数据。

##### 2.1.1.1 功能码

Modbus功能码用于指定主设备请求从设备执行的特定操作。每个功能码定义了一种操作类型，例如读取数据、写入数据、诊断等。因此接下来将分功能归类讲解Modbus功能码。

###### 2.1.1.1.1 数据读写功能码

Modbus中预先定义了一些数据结构，比如：
- 线圈寄存器( `coils` )：1个bit的<font color="#c00000">读写</font>寄存器，通常表示 `TRUE/FALSE` 、 `ON/OFF` 等。
- 离散输入寄存器( `Discrete Inputs` )：1个bit的<span style="background:#fff88f"><font color="#c00000">只读</font></span>寄存器
- 保持寄存器：16个bit的<font color="#c00000">读写</font>寄存器
- 输入寄存器：16个bit的<span style="background:#fff88f"><font color="#c00000">只读</font></span>寄存器
为了方便叙述，将上述的16bit称之为 "字" ，即 "word" 。但是要注意并不是所有的CPU平台的 "word" 长度均为16bit。

相对应的读写功能码列表如下：

| 功能       | 功能码 | 操作类型 | 操作数量  |
| -------- | --- | ---- | ----- |
| 读线圈寄存器   | 01  | 位    | 单个或多个 |
| 读离散线圈寄存器 | 02  | 位    | 单个或多个 |
| 读保持寄存器   | 03  | 字    | 单个或多个 |
| 读输入寄存器   | 04  | 字    | 单个或多个 |
| 写单个线圈寄存器 | 05  | 位    | 单个    |
| 写单个保持寄存器 | 06  | 字    | 单个    |
|          |     |      |       |
| 写多个线圈寄存器 | 0F  | 位    | 多个    |
| 写多个保持寄存器 | 10  | 字    | 多个    |



##### 2.1.1.2 数据