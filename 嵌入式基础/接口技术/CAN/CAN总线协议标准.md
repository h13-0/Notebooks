---
number headings: auto, first-level 2, max 6, 1.1
---
#嵌入式 

## 1 目录

```toc
```

## 2 CAN总线简介

CAN总线全称为Controller Area Network Bus，即控制器局域网总线。其由BOSCH公司制定和开发，其主要应用于汽车、工业控制等嵌入式领域。其最主要的特征是可靠性、易拓展性。
CAN总线协议主要涵盖了OSI/ISO七层网络协议中的<u>传输层</u>、<u>数据链路层</u>和<u>物理层</u>。

![[msedge_pbUwS3eDtV.png]]

其特性主要有：
1. 其传输线路为差分线路，使用 `CAN_H` 和 `CAN_L` 两根差分线路，电气连接较为简洁，抗干扰性较高。
2. 其按照传输速度可以分为如下两种：
	1. 高速CAN总线，协议标准为ISO11898，传输速率为125kbps~1Mbps，传输距离小于40m。
	2. 低速CAN总线，协议标准为ISO11519，传输速率为10kbps~125kbps，传输距离小于1km。
3. 其物理层特性与RS-485一致，为<font color="#c00000">异步</font>、<font color="#c00000">半双工</font>通信协议。
4. 可挂载多设备，支持多个设备之间相互通信，多设备同时请求总线时通过仲裁决定传输顺序。
5. 支持11位/29位报文ID，用于区分消息功能，以及确定优先级。
6. 可以配置1~8Byte的有效载荷。
7. 传输时有两种模式：
	1. 广播式传输
	2. 请求式传输
8. 有应答、CRC校验、位填充、位同步、错误处理等传输可靠性机制，可靠性极强。

## 3 电气特性及其规定

如上文所述，协议规定了CAN总线有高速CAN总线和低速CAN总线两种，其电气连接模型分别如各子章节所述。

### 3.1 高速CAN总线电气特性及规定

#### 3.1.1 电气连接示意图及其基本规定

如下图为高速CAN总线的电气示意图。
![[Pasted image 20241027235311.png]]

其规定了高速CAN总线：
1. 多个CAN设备之间并行连接，且CAN控制器和CAN总线之间需要使用CAN收发器进行转换。<font color="#c00000">需要注意高低速CAN总线差分线路电平规定不同</font>。
2. <font color="#c00000">其两端需要添加120欧的终端电阻</font>，用于保<font color="#c00000">持这组差分线在空闲状态下电平一致</font>，以及<font color="#c00000">防止回波反射</font>。
3. <font color="#c00000">因此高速CAN总线又叫闭环CAN总线</font>。
4. <span style="background:#fff88f"><font color="#c00000">其总线上最多连接30个单元</font></span>。

#### 3.1.2 高速CAN总线电平规定

和大多数通信协议一样，<font color="#c00000">当其需要传输逻辑 "1" 时</font>，<span style="background:#fff88f"><font color="#c00000">其GPIO其实什么都不需要做</font></span>，此时 $CAN\_H - CAN\_L = 0$ 。此时的电平<font color="#c00000">又被称</font>为 "<font color="#c00000">隐形电平</font>" 。其示意图如下：
	![[Pasted image 20241028155230.png]]
其具体的电平要求为：

| 电平项    | 逻辑1最低值 | 逻辑1标准值 | 逻辑1最大值 | 逻辑0最低值 | 逻辑0标准值 | 逻辑0最大值 |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| CAN_H  | 2.00   | 2.50   | 3.00   | 2.75   | 3.50   | 4.50   |
| CAN_L  | 2.00   | 2.50   | 3.00   | 0.50   | 1.50   | 2.25   |
| V(H-L) | -0.5   | 0.00   | 0.05   | 1.50   | 2.00   | 3.00   |



### 3.2 低速CAN总线电气特性及规定

#### 3.2.1 电气连接示意图及其基本规定

如下图为低速CAN总线的电气示意图。
![[Pasted image 20241027235316.png]]

其中规定了低速CAN总线：
1. 多个CAN设备之间并行连接，且CAN控制器和CAN总线之间需要使用CAN收发器进行转换。<font color="#c00000">需要注意高低速CAN总线差分线路电平规定不同</font>。
2. CAN_H和CAN_L的一端添加一个2.2k欧的终端电阻，用于<font color="#c00000">防止回波反射</font>。
3. <span style="background:#fff88f"><font color="#c00000">其总线上最多连接20个单元</font></span>。

#### 3.2.2 低速CAN总线电平规定



## 4 CAN总线编码

### 4.1 CAN总线帧的种类

CAN总线一共规定了如下的五种帧类型：
1. 数据帧：用于发送单元向接收单元传送数据的帧。
2. 遥控帧：用于接收单元向具有相同ID的发送单元请求数据的帧。
3. 错误帧：用于当检测出错误时向其它单元通知错误的帧。
4. 过载帧：用于接收单元通知其尚未做好接收准备的帧。
5. 帧间隔：用于将数据帧及遥控帧与前面的帧分离开来的帧。
其中，<font color="#c00000">数据帧和遥控帧的帧ID有11位和29位两种</font>，<font color="#c00000">分别称作标准格式和拓展格式</font>。

#### 4.1.1 数据帧

![[msedge_6vDNAJZ5EV.png]]
注：
- 上图中"D"表示显性，即逻辑0、Dominant
- 上图中"R"表示隐形，即逻辑1、Recessive
- 上图中"D/R"表示取决于具体的数据值
- 上图每种<font color="#c00000">帧正中的数字</font>"1"、"11"、"4"、"0-64"等<font color="#c00000">表示帧长度</font>，而不表示数字

##### 4.1.1.1 标准格式

在CAN总线数据帧的标准格式下，帧的各个结构分别为：

| 所述段 | 帧结构(按时间顺序)      | 总线电平     | 长度  | 含义                                                                                                       |
| --- | --------------- | -------- | --- | -------------------------------------------------------------------------------------------------------- |
|     | 0. 传输开始之前，总线空闲  | 逻辑"1"    | N/A | 总线空闲                                                                                                     |
|     |                 |          |     |                                                                                                          |
| 起始段 | 1. 帧起始(SOF)     | 逻辑"0"    | 1   |                                                                                                          |
|     |                 |          |     |                                                                                                          |
| 仲裁段 | 2. 帧ID          | 取决于帧ID数据 | 11  |                                                                                                          |
| 仲裁段 | 3. 远程请求标志位(RTR) | 逻辑"0"    | 1   | 表示不需要请求远程数据。<br><font color="#c00000">用于区分数据帧和遥控帧</font>。<br><font color="#c00000">类似于I2C地址中的读写位</font>。 |
|     |                 |          |     |                                                                                                          |
| 控制段 | 4. ID扩展标志位(IDE) | 逻辑"0"    | 1   | <font color="#c00000">用于表示ID长度是否需要扩展</font>。<br>标准格式的IDE始终为0，扩展格式始终为1。<br>在扩展格式出现前，该位为预留位r0。             |
| 控制段 | 5. 预留位(r0)      | 逻辑"0"    | 1   | 预留位，在扩展格式出现前，该为为r1。                                                                                      |
|     | 6.              |          |     |                                                                                                          |

##### 4.1.1.2 拓展格式







