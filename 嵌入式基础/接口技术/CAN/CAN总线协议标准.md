---
number headings: auto, first-level 2, max 6, 1.1
---
#嵌入式 

## 1 目录

```toc
```

## 2 CAN总线简介

CAN总线全称为Controller Area Network Bus，即控制器局域网总线。其由BOSCH公司制定和开发，其主要应用于汽车、工业控制等嵌入式领域。其最主要的特征是可靠性、易拓展性。
CAN总线协议主要涵盖了OSI/ISO七层网络协议中的<u>传输层</u>、<u>数据链路层</u>和<u>物理层</u>。

![[msedge_pbUwS3eDtV.png]]

其特性主要有：
1. 其传输线路为差分线路，使用 `CAN_H` 和 `CAN_L` 两根差分线路，电气连接较为简洁，抗干扰性较高。
2. 其按照传输速度可以分为如下两种：
	1. 高速CAN总线，协议标准为ISO11898，传输速率为125kbps~1Mbps，传输距离小于40m。
	2. 低速CAN总线，协议标准为ISO11519，传输速率为10kbps~125kbps，传输距离小于1km。
3. 其物理层特性与RS-485一致，为<font color="#c00000">异步</font>、<font color="#c00000">半双工</font>通信协议。
4. 可挂载多设备，支持多个设备之间相互通信，多设备同时请求总线时通过仲裁决定传输顺序。
5. 支持11位/29位报文ID，用于区分消息功能，以及确定优先级。
6. 可以配置为指定长度的数据载荷：
	1. CAN Classical支持配置为 $[0, 8]$ Bytes
	2. CAN FD(Flexible Data-Rate)支持配置为 $\{[0, 8], 12, 16, 20, 24, 32, 48, 64\}$ Bytes
7. 传输时有两种模式：
	1. 广播式传输
	2. 请求式传输
8. 有应答、CRC校验、位填充、位同步、错误处理等传输可靠性机制，可靠性极强。

## 3 电气特性及其规定

如上文所述，协议规定了CAN总线有高速CAN总线和低速CAN总线两种，其电气连接模型分别如各子章节所述。

### 3.1 高速CAN总线电气特性及规定

#### 3.1.1 电气连接示意图及其基本规定

如下图为高速CAN总线的电气示意图。
![[Pasted image 20241027235311.png]]

其规定了高速CAN总线：
1. 多个CAN设备之间并行连接，且CAN控制器和CAN总线之间需要使用CAN收发器进行转换。<font color="#c00000">需要注意高低速CAN总线差分线路电平规定不同</font>。
2. <font color="#c00000">其两端需要添加120欧的终端电阻</font>，用于保<font color="#c00000">持这组差分线在空闲状态下电平一致</font>，以及<font color="#c00000">防止回波反射</font>。
3. <font color="#c00000">因此高速CAN总线又叫闭环CAN总线</font>。
4. <span style="background:#fff88f"><font color="#c00000">其总线上最多连接30个单元</font></span>。

#### 3.1.2 高速CAN总线电平规定

和大多数通信协议一样，<font color="#c00000">当其需要传输逻辑 "1" 时</font>，<span style="background:#fff88f"><font color="#c00000">其GPIO其实什么都不需要做</font></span>，此时 $CAN\_H - CAN\_L = 0$ 。此时的电平<font color="#c00000">又被称</font>为 "<font color="#c00000">隐形电平</font>" 。其示意图如下：
	![[Pasted image 20241028155230.png]]
其具体的电平要求为：

| 电平项    | 逻辑1最低值 | 逻辑1标准值 | 逻辑1最大值 | 逻辑0最低值 | 逻辑0标准值 | 逻辑0最大值 |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| CAN_H  | 2.00   | 2.50   | 3.00   | 2.75   | 3.50   | 4.50   |
| CAN_L  | 2.00   | 2.50   | 3.00   | 0.50   | 1.50   | 2.25   |
| V(H-L) | -0.5   | 0.00   | 0.05   | 1.50   | 2.00   | 3.00   |



### 3.2 低速CAN总线电气特性及规定

#### 3.2.1 电气连接示意图及其基本规定

如下图为低速CAN总线的电气示意图。
![[Pasted image 20241027235316.png]]

其中规定了低速CAN总线：
1. 多个CAN设备之间并行连接，且CAN控制器和CAN总线之间需要使用CAN收发器进行转换。<font color="#c00000">需要注意高低速CAN总线差分线路电平规定不同</font>。
2. CAN_H和CAN_L的一端添加一个2.2k欧的终端电阻，用于<font color="#c00000">防止回波反射</font>。
3. <span style="background:#fff88f"><font color="#c00000">其总线上最多连接20个单元</font></span>。

#### 3.2.2 低速CAN总线电平规定




### 3.3 位填充

位填充本质上仍然是物理层的编码特性。其规定：
	<font color="#c00000">当CAN总线上连续出现5个相同的电平时，会自动追加一个相反的电平位</font>。
	发送方需要自动追加，接收方需要自动剔除。
类似于计算机网络中的4B/5B编码(但不同)：
	![[第二章 物理层#2 2 3 1 6 4B 5B编码]]
在CAN总线中，位填充的示例如下：

| <center>环节</center> | <center>数据示例1</center>                                                          | 数据示例2                                                                                                                                                   |
| ------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 发送方欲发送：             | 100000110                                                                       | 10000011110                                                                                                                                             |
| 发送方实际发送：            | 100000<span style="background:#fff88f"><font color="#c00000">1</font></span>110 | 100000<span style="background:#fff88f"><font color="#c00000">1</font></span>1111<span style="background:#fff88f"><font color="#c00000">0</font></span>0 |
| 接收方实际接收：            | 100000<span style="background:#fff88f"><font color="#c00000">1</font></span>110 | 100000<span style="background:#fff88f"><font color="#c00000">1</font></span>1111<span style="background:#fff88f"><font color="#c00000">0</font></span>0                                                                      |
| 接收方收到：              | 100000110                                                                       | 10000011110                                                                                                                                             |
注：
1. 当总线上已经发送5个相同bit后，无论欲发送的下一位是否反转，立刻插入一位相反电平位(示例1)。
2. <span style="background:#fff88f"><font color="#c00000">插入的相反电平位也要计入"5个相同bit"判定条件的计数</font></span>(示例2)。
填充位的作用：
1. 增加波形的定时信息，利于接收方执行“再同步”，防止波形长时间无变化，导致接收方不能精确掌握数据采样时机。
2. 将正常数据流与“错误帧”和“过载帧”区分开，标志“错误帧”和“过载帧”的特异性。
3. 保持CAN总线在发送正常数据流时的活跃状态，防止被误认为总线空闲。
具体可以结合下一章节进行理解。

## 4 CAN总线编码

### 4.1 CAN总线帧的种类

CAN总线一共规定了如下的五种帧类型：
1. 数据帧：用于发送单元向接收单元传送数据的帧。
2. 遥控帧：用于接收单元向具有相同ID的发送单元请求数据的帧。
3. 错误帧：用于当检测出错误时向其它单元通知错误的帧。
4. 过载帧：用于接收单元通知其尚未做好接收准备的帧。
5. 帧间隔：用于将数据帧及遥控帧与前面的帧分离开来的帧。
其中，<font color="#c00000">数据帧和遥控帧的帧ID有11位和29位两种</font>，<font color="#c00000">分别称作标准格式和拓展格式</font>。

#### 4.1.1 数据帧

![[msedge_6vDNAJZ5EV.png]]
注：
- 上图中"D"表示显性，即逻辑0、Dominant
- 上图中"R"表示隐形，即逻辑1、Recessive
- 上图中"D/R"表示取决于具体的数据值
- 上图每种<font color="#c00000">帧正中的数字</font>"1"、"11"、"4"、"0-64"等<font color="#c00000">表示帧长度</font>，而不表示数字

##### 4.1.1.1 标准格式

在CAN总线数据帧的标准格式下，帧的各个结构分别为：

| 所述段  | 帧结构(按时间顺序)      | 总线电平                                                                         | 长度            | 含义                                                                                                                            |
| ---- | --------------- | ---------------------------------------------------------------------------- | ------------- | ----------------------------------------------------------------------------------------------------------------------------- |
|      | 0. 传输开始之前，总线空闲  | 逻辑"1"                                                                        | N/A           | 总线空闲                                                                                                                          |
| 起始段  | 1. 帧起始(SOF)     | 逻辑"0"                                                                        | 1             |                                                                                                                               |
| 仲裁段  | 2. 帧ID          | 取决于帧ID数据                                                                     | 11            |                                                                                                                               |
| 仲裁段  | 3. 远程请求标志位(RTR) | 逻辑"0"                                                                        | 1             | 表示不需要请求远程数据。<br><font color="#c00000">用于区分数据帧和遥控帧</font>。<br><font color="#c00000">类似于I2C地址中的读写位</font>。                      |
| 控制段  | 4. ID扩展标志位(IDE) | 逻辑"0"                                                                        | 1             | <font color="#c00000">用于表示ID长度是否需要扩展</font>。<br>标准格式的IDE始终为0，扩展格式始终为1。<br>在扩展格式出现前，该位为预留位r0。                                  |
| 控制段  | 5. 预留位(r0)      | 逻辑"0"                                                                        | 1             | 预留位，在扩展格式出现前，该为为r1。                                                                                                           |
| 控制段  | 6. 数据段长度(DLC)   | 取决于数据段长度                                                                     | 4             | <font color="#c00000">表示数据段的</font><span style="background:#fff88f"><font color="#c00000">字节数</font></span>，二进制，值为 $[0, 8]$ 。 |
| 数据段  | 7. 数据段(DATA)    | 取决于数据                                                                        | $8\times k$字节 | <span style="background:#fff88f"><font color="#c00000">其数据段长度一定是8的倍数</font></span>，<font color="#c00000">因为是以Byte为单位</font>。  |
| CRC段 | 8. CRC段         | CRC校验值                                                                       | 15            | <font color="#c00000">从SOF到DATA</font>的CRC校验码。                                                                                |
| CRC段 | 9. CRC界定符       | 逻辑"1"                                                                        | 1             |                                                                                                                               |
| ACK段 | 10.ACK位槽        | <font color="#c00000">发送者为"1"</font><br><font color="#c00000">接受者为"0"</font> | 1             | 做ACK应答，以及表明发送和接收身份。<br>发送包和接收包不一样，表明接收成功。                                                                                     |
| ACK段 | 11.ACK界定符       | 逻辑"1"                                                                        |               |                                                                                                                               |
| 帧结束  | 12.帧结束(EOF)     | 逻辑"1"                                                                        | 7             | 触发总线空闲。<br>由于长度为7，一次                                                                                                          |

注：
- 远程请求标志位(RTR)：
	- 在CAN Classical中，支持配置为 $[0, 8]$ Bytes，<font color="#c00000">当四位RTR值大于等于8时，均表示8Byte</font>。
	- 在CAN FD中，支持配置为 $\{[0, 8], 12, 16, 20, 24, 32, 48, 64\}$ Bytes。
	- 对应表如下表所示(ISO 11898-1 Table 5)：
		![[msedge_kbPXuqXSa8.png]]

##### 4.1.1.2 拓展格式

扩展格式总体与标准格式一致，其主要在于总裁段和控制段有所不同

| 所述段 | 帧结构(按时间顺序)      | 总线电平                                           | 长度  | 含义                                       |
| --- | --------------- | ---------------------------------------------- | --- | ---------------------------------------- |
| ... |                 |                                                |     |                                          |
| 仲裁段 | 1. 帧ID(前11位)    | 取决于帧ID数据                                       | 11  | 前11位帧ID                                  |
| 仲裁段 | 2. 替代远程请求(SRR)  | <font color="#c00000">逻辑"1"</font><br>与RTR电平不同 | 1   | 由于标准格式优先级大于拓展格式，<br>因此该位。<br>            |
| 仲裁段 | 4. ID扩展标志位(IDE) | <font color="#c00000">逻辑"1"</font>             | 1   | 表示为扩展格式。<br>如果不兼容拓展格式的老设备会由于该位为1而忽略该数据帧。 |
| 仲裁段 | 5. 帧ID(后18位)    | 取决于帧ID数据                                       | 18  | 后18位帧ID                                  |
| 仲裁段 | 6. 远程请求标志位(RTR) | 逻辑"0"                                          | 1   | ...                                      |
| 控制段 | 7. 新的预留位(r1)    | 逻辑"0"                                          | 1   |                                          |
| 控制段 | 8. 新的预留位(r0)    | 逻辑"0"                                          | 1   |                                          |
| 控制段 | 9. 数据段长度(DLC)   | ...                                            | 4   | ...                                      |

#### 4.1.2 遥控帧

![[msedge_9IyZqWpA0b.png]]

##### 4.1.2.1 标准格式

帧结构总体与数据帧相同，区别点在于：
1. <font color="#c00000">远程请求标志位(RTR)为逻辑"1"</font>。
2. <span style="background:#fff88f"><font color="#c00000">遥控帧无数据段</font></span>，<font color="#c00000">用于在请求式传输中主动请求其他设备的数据</font>。

##### 4.1.2.2 拓展格式

略

#### 4.1.3 错误帧

总线上的所有设备都会监督总线的数据，一旦发现：
- 位错误
- 错误填充
- CRC校验错误
- 格式错误
- 应答错误
时，所有设备都会发出错误帧来破坏总线上的数据传输，并告知其他所有设备该帧错误。

错误帧结构如下图所示：
	![[msedge_N6LCmysPVx.png]]
如基本电气规定所述，CAN总线拥有"线与"特性，即<font color="#c00000">总线上只要有一个设备发出逻辑"0"，则总线上的数据就会被定义为逻辑"0"</font>。
而上图中的：
- 被动错误标志：当主动错误出现过于频繁，则设备会进入被动错误状态，会发逻辑"1"破坏自己发送的数据(懒得管总线命令，自己也闭嘴了)。
- 主动错误标志：出于主动错误状态的设备会发出主动错误标志，会<font color="#c00000"><u>连续使用6个</u>逻辑"0"</font>拉开总线
- 上图中错误标志后半的"0~6"是延长时间，当一个设备发出错误标志后其他设备也会连带着发送错误标志，导致时间差，因此最多就是6位的错误重叠，即12位的错误部分。
- 随后的8个错误界定符TODO

#### 4.1.4 过载帧

过载帧表示接收设备尚未做好接收准备。其通常是在发送方数据量过大时，接收方发出。
过载帧结构如下图所示：
	![[msedge_u6Gbc7hz8U.png]]
其和错误帧定义一致，只是产生条件不同。

#### 4.1.5 帧间隔

帧间隔用于将数据帧和遥控帧与前面的帧分开(在未出现异常时，总线上只会有这两种帧)。
帧结构如下：
	![[msedge_BNLcx9M5VX.png]]
帧间隔也分为主动错误状态和被动错误状态：
1. 主动错误状态的帧间隔为3位
2. 被动错误状态的真间隔为3位+8位延迟传输。延迟传输会将设备至于仲裁不利的处境。




